<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ポケモンアドベンチャー</title>
    <!--link rel="stylesheet" href="css/poke.css"-->
</head>
<style>
/* 基本スタイルとフォント */
@import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');

:root {
    --bg-color: #111;
    --text-color: #fff;
    --border-color: #888;
    --button-bg: #f0f0f0;
    --button-text: #222;
    --button-hover-bg: #ddd;
    --hp-high: #32CD32;
    --hp-mid: #FFD700;
    --hp-low: #FF4500;
    --exp-color: #00FFFF;
    --mega-button-bg: #8A2BE2;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    font-family: 'DotGothic16', sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
}

#game-container {
    position: relative;
    width: 100%;
    height: 100%;
}

button {
    font-family: 'DotGothic16', sans-serif;
    padding: 12px 24px;
    font-size: 1.2rem;
    cursor: pointer;
    border: 2px solid var(--border-color);
    border-radius: 30px;
    background-color: var(--button-bg);
    color: var(--button-text);
    transition: all 0.2s ease;
}

button:hover:not(:disabled) {
    background-color: var(--button-hover-bg);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

button:disabled {
    cursor: not-allowed;
    opacity: 0.5;
}

.screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.5s ease, visibility 0.5s;
    background-size: cover;
    background-position: center;
    padding: 20px;
}

.screen.active {
    opacity: 1;
    visibility: visible;
}

.back-button {
    position: absolute;
    top: 20px;
    left: 20px;
    z-index: 1000;
}

/* タイトル画面 */
#title-screen {
    background-image: url('../assets/title_screen.png');
}

.title-menu {
    display: flex;
    flex-direction: column;
    gap: 15px;
    background-color: rgba(0, 0, 0, 0.5);
    padding: 40px;
    border-radius: 20px;
}

.title-menu button {
    width: 300px;
}

/* 選択画面 */
#selection-screen, #slot-selection-screen {
    background-image: url('../assets/zukan_bg.png');
}

.selection-box, .slot-box, .info-box {
    background-color: rgba(0, 0, 0, 0.7);
    padding: 30px;
    border-radius: 15px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: center;
    width: 90%;
    max-width: 600px;
}

input, select {
    width: 100%;
    padding: 10px;
    font-family: 'DotGothic16', sans-serif;
    font-size: 1rem;
    border-radius: 5px;
    border: 1px solid var(--border-color);
}

.error-text {
    color: var(--hp-low);
    font-weight: bold;
}

#slot-container {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.slot-row {
    display: flex;
    gap: 10px;
    align-items: center;
}

.slot-row button {
    flex-grow: 1;
}

.delete-button {
    background: none;
    border: none;
    font-size: 1.8rem;
    color: #ccc;
}
.delete-button:hover {
    color: var(--hp-low);
}


/* 戦闘画面 */
#battle-screen {
    background-image: url('../assets/background.png');
    justify-content: space-between;
    padding: 10px;
}

.battle-arena {
    width: 100%;
    display: flex;
    justify-content: space-around;
    align-items: flex-end;
    flex-grow: 1;
}

.player-side, .opponent-side {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 45%;
    max-width: 500px;
}

.player-side {
    align-self: flex-end;
}

.opponent-side {
    align-self: flex-start;
    margin-top: 2%;
}

.pokemon-info-container {
    position: relative;
    width: 100%;
    display: flex;
    justify-content: center;
}

.player-side .pokemon-info-container {
    transform: translateX(-20%);
}

.opponent-side .pokemon-info-container {
    transform: translateX(20%);
}


.trainer-info {
    position: absolute;
    bottom: 0;
}

.player-side .trainer-info { left: -10%; }
.opponent-side .trainer-info { right: -10%; }


.trainer-info img {
    height: 150px;
    opacity: 0.8;
}

#player-pokemon-image, #opponent-pokemon-image {
    width: 250px;
    height: 250px;
    object-fit: contain;
    transition: transform 0.3s ease;
}

.status-box {
    position: absolute;
    background-color: rgba(30, 30, 30, 0.8);
    border: 3px solid #f0f0f0;
    border-radius: 15px;
    padding: 10px;
    width: 280px;
    color: white;
}

.player-side .status-box {
    bottom: -30px;
    right: 0;
}

.opponent-side .status-box {
    top: 0;
    left: 0;
}

.name-level { font-size: 1.4rem; font-weight: bold; margin-bottom: 5px; }
.hp-text, .exp-text { font-size: 1rem; text-align: right; }
.hp-bar-container, .exp-bar-container {
    width: 100%;
    background-color: #555;
    border-radius: 10px;
    overflow: hidden;
    margin: 5px 0;
}
.hp-bar, .exp-bar {
    height: 15px;
    width: 100%;
    border-radius: 10px;
    transition: width 0.5s ease-out, background-color 0.5s ease;
}
.hp-bar { background-color: var(--hp-high); }
.exp-bar { background-color: var(--exp-color); }

/* 下部パネル */
.bottom-panel {
    width: 100%;
    max-width: 900px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
.message-window {
    width: 100%;
    min-height: 100px;
    background-color: rgba(0, 0, 0, 0.8);
    border: 3px solid var(--border-color);
    border-radius: 15px;
    padding: 20px;
    text-align: center;
}
#message-text { font-size: 1.5rem; }

.command-area { width: 100%; }
.command-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
}
#mega-evolve-button {
    background-color: var(--mega-button-bg);
    color: white;
}

/* 図鑑・情報画面 */
#dex-screen, #info-screen {
    background-image: url('../assets/zukan_bg.png');
}

.dex-container, .info-box {
    width: 90%;
    max-width: 1100px;
    height: 90%;
    background-color: rgba(0, 0, 0, 0.7);
    border-radius: 15px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.dex-nav { display: flex; justify-content: center; gap: 10px; }
.dex-nav button.active { background-color: #888; color: white; }
.dex-content { display: flex; gap: 15px; flex-grow: 1; overflow: hidden; }
.dex-list {
    width: 250px;
    overflow-y: auto;
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 10px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
}
.dex-list button, .dex-list select {
    width: 100%;
    background: none;
    border: none;
    color: white;
    text-align: left;
    font-size: 1.1rem;
    padding: 8px;
    border-radius: 5px;
}
.dex-list button:hover { background-color: rgba(255, 255, 255, 0.2); }
.dex-details {
    flex-grow: 1;
    overflow-y: auto;
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
}
#info-content { overflow-y: auto; }
#info-content h2 { margin-top: 20px; }
#info-content p { margin-top: 10px; line-height: 1.6; }

/* モーダル */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}
.modal-content {
    background-color: #333;
    padding: 30px;
    border-radius: 15px;
    border: 3px solid var(--border-color);
    width: 90%;
    max-width: 500px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
#move-forget-options { display: flex; flex-direction: column; gap: 10px; }
#move-forget-options label { font-size: 1.1rem; }

#shop-item-list {
    max-height: 300px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.shop-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background-color: rgba(255,255,255,0.1);
    border-radius: 8px;
}

/* アニメーション */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
    20%, 40%, 60%, 80% { transform: translateX(8px); }
}
@keyframes flash-red {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(1.5) sepia(1) hue-rotate(-50deg) saturate(5); }
}
@keyframes player-attack {
    0% { transform: translate(-20%, 0); }
    50% { transform: translate(-10%, -10px); }
    100% { transform: translate(-20%, 0); }
}
@keyframes opponent-attack {
    0% { transform: translate(20%, 0); }
    50% { transform: translate(10%, 10px); }
    100% { transform: translate(20%, 0); }
}
@keyframes faint {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(50px); opacity: 0; }
}
@keyframes level-up-glow {
    0%, 100% { filter: drop-shadow(0 0 0 #fff); }
    50% { filter: drop-shadow(0 0 15px #00FFFF); }
}

.is-attacking-player { animation: player-attack 0.5s ease-in-out; }
.is-attacking-opponent { animation: opponent-attack 0.5s ease-in-out; }
.is-taking-damage { animation: shake 0.5s, flash-red 0.5s; }
.is-fainted { animation: faint 1s forwards; }
.is-leveling-up { animation: level-up-glow 1s infinite; }

/* レスポンシブ対応 */
@media (max-width: 768px) {
    button { font-size: 1rem; padding: 10px 16px; }
    .title-menu button { width: 250px; }
    .battle-arena { flex-direction: column; align-items: center; justify-content: flex-start; gap: 20px; }
    .player-side, .opponent-side { width: 100%; max-width: 400px; }
    .player-side { order: 2; align-self: center; }
    .opponent-side { order: 1; align-self: center; }
    .player-side .pokemon-info-container, .opponent-side .pokemon-info-container { transform: translateX(0); }
    #player-pokemon-image, #opponent-pokemon-image { width: 180px; height: 180px; }
    .status-box { width: 220px; padding: 8px; }
    .name-level { font-size: 1.1rem; }
    .hp-bar { height: 12px; }
    .trainer-info img { height: 100px; }
    .message-window { min-height: 80px; }
    #message-text { font-size: 1.2rem; }
    .command-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
    .dex-content { flex-direction: column; }
    .dex-list { width: 100%; height: 150px; flex-shrink: 0; }
}
    </style>
<body>
    <div id="game-container">
        <!-- どの画面にも表示されるタイトルへ戻るボタン -->
        <button id="back-to-title-button" class="back-button" style="display: none;">タイトルへもどる</button>

        <!-- タイトル画面 -->
        <div id="title-screen" class="screen">
            <div class="title-menu">
                <button data-action="new-game">さいしょから</button>
                <button data-action="load-game">つづきから</button>
                <button data-action="how-to-play">あそびかた</button>
                <button data-action="pokedex">ずかん</button>              
                <button data-action="quit">やめる</button>
            </div>
        </div>

        <!-- キャラクター選択画面 -->
        <div id="selection-screen" class="screen">
            <div class="selection-box">
                <h1>メンバーをえらぼう！</h1>
                <input type="text" id="trainer-name-input" placeholder="なまえ" value="サトシ">
                <select id="trainer-avatar-select"></select>
                <select id="pokemon-select"></select>
                <input type="text" id="pokemon-nickname-input" placeholder="ニックネーム（任意）">
                <p id="selection-error" class="error-text"></p>
                <button id="start-game-button">このメンバーではじめる</button>
            </div>
        </div>

        <!-- セーブ/ロード画面 -->
        <div id="slot-selection-screen" class="screen">
            <div class="slot-box">
                <h1 id="slot-title"></h1>
                <div id="slot-container"></div>
            </div>
        </div>

        <!-- 戦闘画面 -->
        <div id="battle-screen" class="screen">
            <div class="battle-arena">
                <!-- 相手側 -->
                <div class="opponent-side">
                    <div class="trainer-info">
                        <img id="opponent-trainer-image" src="" alt="Opponent Trainer">
                    </div>
                    <div class="pokemon-info-container">
                        <img id="opponent-pokemon-image" src="" alt="Opponent Pokemon">
                        <div id="opponent-status" class="status-box">
                            <div class="name-level"><span id="opponent-name-text"></span> Lv.<span id="opponent-level-text"></span></div>
                            <div class="hp-bar-container">
                                <div id="opponent-hp-bar" class="hp-bar"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- プレイヤー側 -->
                <div class="player-side">
                    <div class="trainer-info">
                        <img id="player-trainer-image" src="" alt="Player Trainer">
                    </div>
                    <div class="pokemon-info-container">
                         <img id="player-pokemon-image" src="" alt="Player Pokemon">
                        <div id="player-status" class="status-box">
                            <div class="name-level"><span id="player-name-text"></span> Lv.<span id="player-level-text"></span></div>
                            <div class="hp-bar-container">
                                <div id="player-hp-bar" class="hp-bar"></div>
                            </div>
                            <div id="player-hp-text" class="hp-text"></div>
                            <div class="exp-bar-container">
                                <span>EXP</span>
                                <div id="player-exp-bar" class="exp-bar"></div>
                            </div>
                            <div id="player-exp-text" class="exp-text"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 下部パネル -->
            <div class="bottom-panel">
                <div id="message-window" class="message-window">
                    <p id="message-text"></p>
                </div>
                <div id="command-area" class="command-area">
                    <!-- メインコマンド -->
                    <div id="main-commands" class="command-grid">
                        <button data-command="fight">たたかう</button>
                        <button data-command="items">どうぐ</button>
                        <button data-command="shop">かいもの</button>
                        <button data-command="flee">にげる</button>
                        <button id="mega-evolve-button" data-command="mega-evolve" style="display: none;">メガシンカ</button>
                        <button data-command="defend">ぼうぎょ</button>
                    </div>
                    <!-- 技コマンド -->
                    <div id="moves-commands" class="command-grid" style="display: none;"></div>
                    <!-- アイテムコマンド -->
                    <div id="items-commands" class="command-grid" style="display: none;"></div>
                    <!-- 戦闘終了後コマンド -->
                    <div id="end-game-commands" class="command-grid" style="display: none;">
                        <button data-command="continue">ゲームを続ける</button>
                        <button data-command="interrupt">セーブして中断</button>
                        <button data-command="retire">リタイア</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 図鑑画面 -->
        <div id="dex-screen" class="screen">
            <div class="dex-container">
                <div class="dex-nav">
                    <button data-dex-type="pokemon" class="active">ポケモン</button>
                    <button data-dex-type="move">わざ</button>
                    <button data-dex-type="item">どうぐ</button>
                </div>
                <div class="dex-content">
                    <div id="dex-list" class="dex-list"></div>
                    <div id="dex-details" class="dex-details"></div>
                </div>
            </div>
        </div>

        <!-- あそびかた/クレジット画面 -->
        <div id="info-screen" class="screen">
             <div class="info-box">
                <h1 id="info-title"></h1>
                <div id="info-content" class="info-content"></div>
            </div>
        </div>

        <!-- 各種モーダル -->
        <div id="modal-overlay" class="modal-overlay" style="display: none;">
            <!-- 技忘れモーダル -->
            <div id="move-forget-modal" class="modal-content">
                <h2 id="move-forget-title"></h2>
                <div id="move-forget-options"></div>
                <button id="move-forget-confirm">けってい</button>
            </div>
            <!-- 確認モーダル -->
            <div id="confirm-modal" class="modal-content">
                <h2 id="confirm-title"></h2>
                <p id="confirm-text"></p>
                <div class="modal-actions">
                    <button id="confirm-yes">はい</button>
                    <button id="confirm-no">いいえ</button>
                </div>
            </div>
             <!-- 買い物モーダル -->
            <div id="shop-modal" class="modal-content">
                <h2>いらっしゃいませ！</h2>
                <p>所持金: <span id="shop-money"></span>円</p>
                <div id="shop-item-list"></div>
                <button id="shop-close-button">みせを でる</button>
            </div>
        </div>
    </div>

    <!-- オーディオ要素 -->
    <audio id="bgm-audio" loop></audio>

    <!--script src="js/poke.js"></script-->
    <script>
// =============================================================================
// DOM要素の取得
// =============================================================================
document.addEventListener('DOMContentLoaded', () => {
    const game = new Game();
    game.init();
});

// =============================================================================
// ゲーム全体の管理クラス
// =============================================================================
class Game {
    constructor() {
        // ゲームデータ
        this.POKEMON_MASTER_MIKATA = {};
        this.POKEMON_MASTER_TEKI = {};
        this.MOVES_MASTER = {};
        this.ITEMS_MASTER = {};
        this.TRAINER_MASTER = {};
        this.HOW_TO_PLAY_DATA = {};
        this.TYPE_CHART = {};

        // ゲーム状態
        this.playerPokemon = null;
        this.opponentPokemon = null;
        this.playerName = '';
        this.playerAvatarName = '';
        this.opponentName = '';
        this.inventory = {};
        this.money = 1000;
        this.currentDexType = 'pokemon';

        // UI要素
        this.dom = {
            screens: document.querySelectorAll('.screen'),
            backToTitleButton: document.getElementById('back-to-title-button'),
        };
    }

    // =============================================================================
    // 初期化処理
    // =============================================================================
    async init() {
        await this.loadGameData();
        this.setupEventListeners();
        this.setView('title-screen');
    }

    async loadGameData() {
        try {
            const [pokedex, play, types] = await Promise.all([
                fetch('data/pokedex.json').then(res => res.json()),
                fetch('data/play.json').then(res => res.json()),
                fetch('data/type.json').then(res => res.json()),
            ]);

            this.POKEMON_MASTER_MIKATA = pokedex.pokemon.mikata;
            this.POKEMON_MASTER_TEKI = pokedex.pokemon.teki;
            this.ITEMS_MASTER = pokedex.items;
            this.MOVES_MASTER = Object.fromEntries(
                Object.entries(pokedex.moves).map(([key, value]) => [key, new Move(value.name, value.power, value.move_type, value.description)])
            );
            this.HOW_TO_PLAY_DATA = play;
            this.TYPE_CHART = types;
            
            this.TRAINER_MASTER = {
                "サトシ": { "img": "assets/Satoshi.png" }, "ヒカリ": { "img": "assets/Hikari.png" },
                "タケシ": { "img": "assets/Takeshi.png" }, "リコ": { "img": "assets/Riko.png" },
                "セレナ": { "img": "assets/Serena.png" }, "サンゴ": { "img": "assets/Sango.png" }
            };

        } catch (error) {
            console.error("ゲームデータの読み込みに失敗しました:", error);
            document.body.innerHTML = `<div class="error-text">エラー: ゲームデータの読み込みに失敗しました。ファイルを確認してください。</div>`;
        }
    }

    // =============================================================================
    // イベントリスナー設定
    // =============================================================================
    setupEventListeners() {
        document.querySelector('#title-screen .title-menu').addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            const action = e.target.dataset.action;
            switch (action) {
                case 'new-game': this.showSelectionScreen(); break;
                case 'load-game': this.showSlotSelectionScreen(false); break;
                case 'how-to-play': this.showInfoScreen('how-to-play'); break;
                case 'pokedex': this.showDexScreen(this.currentDexType); break;
                case 'quit': window.location.href = 'index1.html'; break;
            }
        });

        this.dom.backToTitleButton.addEventListener('click', () => this.setView('title-screen'));
        
        document.getElementById('start-game-button').addEventListener('click', () => this.startGameFromSelection());

        document.getElementById('main-commands').addEventListener('click', (e) => {
            if(e.target.tagName !== 'BUTTON') return;
            const command = e.target.dataset.command;
            this.handleMainCommand(command);
        });

        document.querySelector('.dex-nav').addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            const dexType = e.target.dataset.dexType;
            if (dexType) {
                this.currentDexType = dexType;
                document.querySelectorAll('.dex-nav button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                this.showDexScreen(dexType, false);
            }
        });
    }

    // =============================================================================
    // 画面遷移
    // =============================================================================
    setView(viewId) {
        this.dom.screens.forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(viewId).classList.add('active');

        const isTitle = viewId === 'title-screen';
        this.dom.backToTitleButton.style.display = isTitle ? 'none' : 'block';
    }
    
    // =============================================================================
    // キャラクター選択画面 (★最初のパートナーを変更★)
    // =============================================================================
    showSelectionScreen() {
        const trainerAvatarSelect = document.getElementById('trainer-avatar-select');
        trainerAvatarSelect.innerHTML = Object.keys(this.TRAINER_MASTER)
            .map(name => `<option value="${name}">${name}</option>`).join('');

        const pokemonSelect = document.getElementById('pokemon-select');
        // 新しいポケモンを追加
        const initialPartners = ["ピカチュウ", "ヒトカゲ", "ゼニガメ", "フシギダネ", "イーブイ"];
        pokemonSelect.innerHTML = initialPartners
            .map(name => `<option value="${name}">${name}</option>`).join('');
            
        document.getElementById('pokemon-nickname-input').placeholder = pokemonSelect.value;
        pokemonSelect.onchange = () => {
            document.getElementById('pokemon-nickname-input').placeholder = pokemonSelect.value;
        };

        this.setView('selection-screen');
    }

    // =============================================================================
    // セーブ/ロード画面表示
    // =============================================================================
    showSlotSelectionScreen(isSaving) {
        const title = document.getElementById('slot-title');
        const slotContainer = document.getElementById('slot-container');
        
        title.textContent = isSaving ? 'どこに きろくしますか？' : 'どのデータからはじめますか？';

        slotContainer.innerHTML = `
            <div class="slot-row"><button>データ１ (まだ つくられていない)</button><button class="delete-button">×</button></div>
            <div class="slot-row"><button>データ２ (まだ つくられていない)</button><button class="delete-button">×</button></div>
            <div class="slot-row"><button>データ３ (まだ つくられていない)</button><button class="delete-button">×</button></div>
        `;
        
        this.setView('slot-selection-screen');
    }

    // =============================================================================
    // あそびかた画面表示
    // =============================================================================
    showInfoScreen(type) {
        const titleEl = document.getElementById('info-title');
        const contentEl = document.getElementById('info-content');
        let contentHTML = '';

        if (type === 'how-to-play') {
            titleEl.textContent = 'あそびかた';
            if (this.HOW_TO_PLAY_DATA && this.HOW_TO_PLAY_DATA.sections) {
                for (const section of this.HOW_TO_PLAY_DATA.sections) {
                    const heading = section.heading || '無題';
                    const body = (section.body || '').replace(/\n/g, '<br>');
                    contentHTML += `<h2>${heading}</h2><p>${body}</p>`;
                }
            } else {
                 contentHTML = '<p>あそびかたデータの読み込みに失敗しました。</p>';
            }
        }
        
        contentEl.innerHTML = contentHTML;
        this.setView('info-screen');
    }
    
    // =============================================================================
    // ずかん画面表示
    // =============================================================================
    showDexScreen(type, shouldSetView = true) {
        const listEl = document.getElementById('dex-list');
        const detailsEl = document.getElementById('dex-details');
        
        listEl.innerHTML = '';
        detailsEl.innerHTML = '<h2>リストから えらんでください</h2>';

        let masterData, detailRenderer;

        switch (type) {
            case 'pokemon':
                masterData = this.POKEMON_MASTER_MIKATA;
                detailRenderer = this.showPokemonDetails.bind(this);
                break;
            case 'move':
                masterData = this.MOVES_MASTER;
                detailRenderer = this.showMoveDetails.bind(this);
                break;
            case 'item':
                masterData = this.ITEMS_MASTER;
                detailRenderer = this.showItemDetails.bind(this);
                break;
            default:
                return;
        }

        for (const name of Object.keys(masterData).sort()) {
            const button = document.createElement('button');
            button.textContent = name;
            button.onclick = () => detailRenderer(name);
            listEl.appendChild(button);
        }
        
        if (shouldSetView) {
            this.setView('dex-screen');
        }
    }

    showPokemonDetails(name) {
        const detailsEl = document.getElementById('dex-details');
        const data = this.POKEMON_MASTER_MIKATA[name];
        if (!data) return;

        detailsEl.innerHTML = `
            <img src="assets/${data.img}" alt="${name}" style="width:150px; height:150px;">
            <h2>${name}</h2>
            <p><strong>タイプ:</strong> ${data.types.join(' / ')}</p>
            <p>${data.description || ''}</p>
            <h3>おぼえるわざ:</h3>
            <p>${(data.learnable_moves || []).join(', ')}</p>
        `;
    }

    showMoveDetails(name) {
        const detailsEl = document.getElementById('dex-details');
        const data = this.MOVES_MASTER[name];
        if (!data) return;

        detailsEl.innerHTML = `
            <h2>${name}</h2>
            <p><strong>タイプ:</strong> ${data.type}</p>
            <p><strong>いりょく:</strong> ${data.power}</p>
            <p>${data.description || ''}</p>
        `;
    }

    showItemDetails(name) {
        const detailsEl = document.getElementById('dex-details');
        const data = this.ITEMS_MASTER[name];
        if (!data) return;

        detailsEl.innerHTML = `
            <h2>${name}</h2>
            <p>${data.description || ''}</p>
        `;
    }

    startGameFromSelection() {
        const trainerName = document.getElementById('trainer-name-input').value;
        const avatarName = document.getElementById('trainer-avatar-select').value;
        const pokemonSpecies = document.getElementById('pokemon-select').value;
        const nickname = document.getElementById('pokemon-nickname-input').value || pokemonSpecies;

        const errorEl = document.getElementById('selection-error');
        if (!/^[ぁ-んァ-ヶa-zA-Z0-9]+$/.test(trainerName)) {
            errorEl.textContent = "トレーナー名には ひらがな、カタカナ、英数字のみ使えます。";
            return;
        }
        if (nickname && !/^[ぁ-んァ-ヶa-zA-Z0-9]+$/.test(nickname)) {
            errorEl.textContent = "ニックネームには ひらがな、カタカナ、英数字のみ使えます。";
            return;
        }
        errorEl.textContent = "";

        this.playerName = trainerName;
        this.playerAvatarName = avatarName;
        this.money = 1000;
        this.inventory = {"すごいキズぐすり": 3, "プラスパワー": 10, "ディフェンダー": 10, "いのちのおまもり": 5, "モンスターボール": 5};

        const pData = this.POKEMON_MASTER_MIKATA[pokemonSpecies];
        const playerHp = pData.hp * 10;
        this.playerPokemon = new Pokemon(pokemonSpecies, 1, pData.types, playerHp, pData.atk, pData.dfs, `assets/${pData.img}`, this);
        this.playerPokemon.name = nickname;
        this.playerPokemon.moves = this.getRandomMoves(pData.learnable_moves, 2);

        this.startNewBattle();
    }

    // =============================================================================
    // 戦闘ロジック
    // =============================================================================
    startNewBattle() {
        const opponentTrainers = Object.keys(this.TRAINER_MASTER).filter(name => name !== this.playerAvatarName);
        this.opponentName = this.getRandomElement(opponentTrainers);
        
        const opponentPokemonName = this.getRandomElement(Object.keys(this.POKEMON_MASTER_TEKI));
        const oData = this.POKEMON_MASTER_TEKI[opponentPokemonName];
        const opponentLevel = Math.max(1, this.playerPokemon.level + this.getRandomInt(-1, 2));
        const opponentHp = oData.hp + opponentLevel * 5;

        this.opponentPokemon = new Pokemon(opponentPokemonName, opponentLevel, oData.types, opponentHp, oData.atk, oData.dfs, `assets/${oData.img}`, this);
        this.opponentPokemon.moves = this.getRandomMoves(oData.learnable_moves, 4);

        this.setView('battle-screen');
        this.updateUI();
        this.showMessage(`${this.opponentName}が しょうぶを しかけてきた！`, 1500)
            .then(() => this.showMessage(`ゆけっ！ ${this.playerPokemon.name}！`, 1500))
            .then(() => this.showMessage("どうする？", 0));
    }
    
    handleMainCommand(command) {
        switch(command) {
            case 'fight': this.showMoveCommands(); break;
            case 'items': this.showItemCommands(); break;
            case 'shop': this.showShop(); break;
        }
    }

    showMoveCommands() {
        const movesContainer = document.getElementById('moves-commands');
        movesContainer.innerHTML = '';
        this.playerPokemon.moves.forEach(move => {
            const button = document.createElement('button');
            button.textContent = move.name;
            button.onclick = () => this.playerAttack(move);
            movesContainer.appendChild(button);
        });
        const backButton = document.createElement('button');
        backButton.textContent = 'もどる';
        backButton.onclick = () => this.showMainCommands();
        movesContainer.appendChild(backButton);

        document.getElementById('main-commands').style.display = 'none';
        movesContainer.style.display = 'grid';
    }

    showItemCommands() {
        console.log("showItemCommands is not implemented yet.");
        this.showMessage("どうぐ をつかう きのうは まだ じっそうされていません", 1500);
    }

    showMainCommands() {
        document.getElementById('moves-commands').style.display = 'none';
        document.getElementById('items-commands').style.display = 'none';
        document.getElementById('main-commands').style.display = 'grid';
    }

    async playerAttack(move) {
        this.showMainCommands();
        this.setCommandsEnabled(false);

        await this.processAttack(this.playerPokemon, this.opponentPokemon, move, 'player');

        if (!this.opponentPokemon.isFainted()) {
            await this.sleep(1000);
            await this.opponentTurn();
        }
        
        if (!this.playerPokemon.isFainted() && !this.opponentPokemon.isFainted()) {
            this.setCommandsEnabled(true);
        }
    }
    
    async opponentTurn() {
        await this.showMessage(`あいての ${this.opponentPokemon.name} のこうげき！`, 1200);
        const move = this.getRandomElement(this.opponentPokemon.moves);
        await this.processAttack(this.opponentPokemon, this.playerPokemon, move, 'opponent');
    }

    async processAttack(attacker, defender, move, side) {
        const attackerImage = document.getElementById(side === 'player' ? 'player-pokemon-image' : 'opponent-pokemon-image');
        const defenderImage = document.getElementById(side === 'player' ? 'opponent-pokemon-image' : 'player-pokemon-image');

        attackerImage.classList.add(side === 'player' ? 'is-attacking-player' : 'is-attacking-opponent');
        await this.showMessage(`${attacker.name} の ${move.name}！`, 1200);
        attackerImage.classList.remove(side === 'player' ? 'is-attacking-player' : 'is-attacking-opponent');
        
        if (move.power === 0) {
            await this.showMessage("しかし うまくきまらなかった！", 1500);
            return;
        }

        let multiplier = 1.0;
        defender.types.forEach(defType => {
            multiplier *= this.TYPE_CHART[move.type]?.[defType] ?? 1;
        });

        if (multiplier > 1) await this.showMessage("こうかは ばつぐんだ！", 800);
        else if (multiplier > 0 && multiplier < 1) await this.showMessage("こうかは いまひとつのようだ…", 800);
        else if (multiplier === 0) await this.showMessage("こうかが ないようだ…", 800);
        
        let damage = Math.ceil(((attacker.level * 0.4 + 2) * move.power * attacker.attack_stat / defender.defense_stat / 50 + 2) * multiplier);
        if (Math.random() < 0.1) {
            await this.showMessage("きゅうしょに あたった！", 800);
            damage = Math.ceil(damage * 1.5);
        }
        if (defender.isDefending) damage = Math.floor(damage / 2);
        damage = Math.max(1, damage);

        defenderImage.classList.add('is-taking-damage');
        defender.current_hp = Math.max(0, defender.current_hp - damage);
        this.updateUI();
        await this.sleep(500);
        defenderImage.classList.remove('is-taking-damage');
        await this.showMessage(`${defender.name} は ${damage} のダメージをうけた！`, 1200);

        if (defender.isFainted()) {
            defenderImage.classList.add('is-fainted');
            await this.showMessage(`${defender.name}は たおれた！`, 1500);
            await this.endBattle(side === 'player'); // awaitを追加して仲間イベントを待つ
        }
    }

    // =============================================================================
    // 戦闘終了処理 (★仲間になる機能を追加★)
    // =============================================================================
    async endBattle(playerWon) {
        if (playerWon) {
            const prizeMoney = this.getRandomInt(100, 500);
            this.money += prizeMoney;
            await this.showMessage(`しょうぶに かった！`, 1500);
            await this.showMessage(`${this.opponentName}から ${prizeMoney}円を てにいれた！`, 1800);
            
            const expGained = 50 * this.opponentPokemon.level;
            await this.playerPokemon.addExp(expGained);
            
            // ★ここから仲間になるイベント★
            // 20% (5回に1回) の確率で発生
            if (Math.random() < 0.2) {
                const capturedPokemonName = this.opponentPokemon.base_name;

                // 倒したポケモンが味方データに存在するか確認
                if (this.POKEMON_MASTER_MIKATA[capturedPokemonName]) {
                    await this.showMessage(`${capturedPokemonName}が なかまに なりたそうに こちらをみている！`, 2000);
                    
                    // 現在のポケモンと入れ替える処理
                    const oldPokemonName = this.playerPokemon.name;
                    const oldPokemonLevel = this.playerPokemon.level; // レベルを引き継ぐ

                    const pData = this.POKEMON_MASTER_MIKATA[capturedPokemonName];
                    const newHp = pData.hp * 10;
                    
                    // 新しいポケモンを生成
                    this.playerPokemon = new Pokemon(capturedPokemonName, oldPokemonLevel, pData.types, newHp, pData.atk, pData.dfs, `assets/${pData.img}`, this);
                    this.playerPokemon.moves = this.getRandomMoves(pData.learnable_moves, 2);

                    await this.showMessage(`${oldPokemonName}と いれかえて、${capturedPokemonName}を なかまに くわえた！`, 2500);
                    this.updateUI(); // UIを更新して新しいポケモンを表示
                }
            }
            
            await this.sleep(1500);
            this.showEndGameCommands();

        } else {
            await this.showMessage(`${this.playerPokemon.name}は たおれた...`, 1500);
            await this.showMessage(`目の前が まっ暗に なった！`, 2000);
            this.showEndGameCommands();
        }
    }
    
    showEndGameCommands() {
        document.getElementById('main-commands').style.display = 'none';
        document.getElementById('end-game-commands').style.display = 'grid';
    }

    // =============================================================================
    // UI更新
    // =============================================================================
    updateUI() {
        if (!this.playerPokemon || !this.opponentPokemon) return;

        document.getElementById('opponent-name-text').textContent = this.opponentPokemon.name;
        document.getElementById('opponent-level-text').textContent = this.opponentPokemon.level;
        const opponentHpPercent = (this.opponentPokemon.current_hp / this.opponentPokemon.max_hp) * 100;
        document.getElementById('opponent-hp-bar').style.width = `${opponentHpPercent}%`;
        this.updateBarColor(document.getElementById('opponent-hp-bar'), opponentHpPercent);
        document.getElementById('opponent-pokemon-image').src = this.opponentPokemon.image_path;
        document.getElementById('opponent-trainer-image').src = this.TRAINER_MASTER[this.opponentName]?.img || '';

        document.getElementById('player-name-text').textContent = this.playerPokemon.name;
        document.getElementById('player-level-text').textContent = this.playerPokemon.level;
        const playerHpPercent = (this.playerPokemon.current_hp / this.playerPokemon.max_hp) * 100;
        document.getElementById('player-hp-bar').style.width = `${playerHpPercent}%`;
        this.updateBarColor(document.getElementById('player-hp-bar'), playerHpPercent);
        document.getElementById('player-hp-text').textContent = `${Math.ceil(this.playerPokemon.current_hp)} / ${this.playerPokemon.max_hp}`;
        
        const expPercent = this.playerPokemon.exp_to_next_level > 0 ? (this.playerPokemon.exp / this.playerPokemon.exp_to_next_level) * 100 : 100;
        document.getElementById('player-exp-bar').style.width = `${expPercent}%`;
        document.getElementById('player-exp-text').textContent = `次のレベルまで: ${Math.max(0, this.playerPokemon.exp_to_next_level - this.playerPokemon.exp)}`;
        
        document.getElementById('player-pokemon-image').src = this.playerPokemon.image_path;
        document.getElementById('player-trainer-image').src = this.TRAINER_MASTER[this.playerAvatarName]?.img || '';
    }

    updateBarColor(barElement, percentage) {
        if (percentage < 20) barElement.style.backgroundColor = 'var(--hp-low)';
        else if (percentage < 50) barElement.style.backgroundColor = 'var(--hp-mid)';
        else barElement.style.backgroundColor = 'var(--hp-high)';
    }

    setCommandsEnabled(isEnabled) {
        document.querySelectorAll('#command-area button').forEach(btn => btn.disabled = !isEnabled);
    }

    // =============================================================================
    // メッセージ表示
    // =============================================================================
    showMessage(text, duration) {
        return new Promise(resolve => {
            const messageText = document.getElementById('message-text');
            messageText.textContent = '';
            let i = 0;
            const typing = setInterval(() => {
                if (i < text.length) {
                    messageText.textContent += text.charAt(i);
                    i++;
                } else {
                    clearInterval(typing);
                    if (duration > 0) {
                        setTimeout(resolve, duration);
                    } else {
                        resolve();
                    }
                }
            }, 50);
        });
    }

    // =============================================================================
    // ヘルパー関数
    // =============================================================================
    getRandomElement(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }

    getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    getRandomMoves(moveList, count) {
        const shuffled = [...moveList].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, Math.min(count, shuffled.length)).map(moveName => this.MOVES_MASTER[moveName]);
    }

    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // =============================================================================
    // 買い物
    // =============================================================================
    showShop() {
        const shopModal = document.getElementById('shop-modal');
        const shopMoney = document.getElementById('shop-money');
        const shopItemList = document.getElementById('shop-item-list');
        const overlay = document.getElementById('modal-overlay');

        shopMoney.textContent = this.money;
        shopItemList.innerHTML = '';

        for (const itemName in this.ITEMS_MASTER) {
            if (!this.ITEMS_MASTER[itemName].effect) continue;

            const item = this.ITEMS_MASTER[itemName];
            const price = this.getRandomInt(150, 450);

            const itemDiv = document.createElement('div');
            itemDiv.className = 'shop-item';
            
            const itemInfo = document.createElement('span');
            itemInfo.textContent = `${itemName} (${price}円)`;
            
            const buyButton = document.createElement('button');
            buyButton.textContent = 'かう';
            buyButton.onclick = () => this.buyItem(itemName, price);

            itemDiv.appendChild(itemInfo);
            itemDiv.appendChild(buyButton);
            shopItemList.appendChild(itemDiv);
        }

        document.getElementById('shop-close-button').onclick = () => {
            shopModal.style.display = 'none';
            overlay.style.display = 'none';
        };

        overlay.style.display = 'flex';
        shopModal.style.display = 'block';
    }

    buyItem(itemName, price) {
        if (this.money < price) {
            this.showMessage("おこづかいが たりない！", 1200);
            return;
        }

        const currentCount = this.inventory[itemName] || 0;
        if (currentCount >= 999) {
            this.showMessage("もう これいじょう もてない！", 1200);
            return;
        }

        this.money -= price;
        this.inventory[itemName] = currentCount + 1;
        
        document.getElementById('shop-money').textContent = this.money;
        this.showMessage(`${itemName}を てにいれた！`, 1200);
    }
}

// =============================================================================
// ポケモンと技のクラス定義
// =============================================================================
class Pokemon {
    constructor(name, level, types, max_hp, attack_stat, defense_stat, image_path, gameInstance) {
        this.base_name = name;
        this.name = name;
        this.level = level;
        this.types = types;
        this.max_hp = max_hp;
        this.current_hp = max_hp;
        this.attack_stat = attack_stat;
        this.defense_stat = defense_stat;
        this.image_path = image_path;
        this.moves = [];
        this.exp = 0;
        this.exp_to_next_level = 10 * (this.level ** 2);
        this.is_defending = false;
        this.game = gameInstance;
    }

    isFainted() {
        return this.current_hp <= 0;
    }
    
    async addExp(amount) {
        if (this.isFainted() || this.level >= 100) return;
    
        await this.game.showMessage(`${this.name}は ${amount}ポイントの けいけんちを かくとく！`, 1500);
    
        this.exp += amount;
        let leveledUp = false;
        while (this.exp >= this.exp_to_next_level && this.level < 100) {
            await this.levelUp();
            leveledUp = true;
        }
        
        if (!leveledUp) {
            this.game.updateUI();
        }
    }

    async levelUp() {
        this.exp -= this.exp_to_next_level;
        this.level++;
        
        const hp_gain = this.game.getRandomInt(20, 50);
        const atk_gain = this.game.getRandomInt(2, 4);
        const dfs_gain = this.game.getRandomInt(2, 4);
        
        this.max_hp += hp_gain;
        this.attack_stat += atk_gain;
        this.defense_stat += dfs_gain;
        this.current_hp = this.max_hp;
        this.exp_to_next_level = 10 * (this.level ** 2);
        
        const playerImage = document.getElementById('player-pokemon-image');
        playerImage.classList.add('is-leveling-up');
        
        await this.game.showMessage(`おや・・・？ ${this.name}の ようすが・・・！`, 1500);
        await this.game.showMessage(`${this.name}は レベル ${this.level}に あがった！`, 2000);
        
        playerImage.classList.remove('is-leveling-up');
        this.game.updateUI();
    }
}

class Move {
    constructor(name, power, move_type, description) {
        this.name = name;
        this.power = power;
        this.type = move_type;
        this.description = description;
    }
}
    </script>
</body>
</html>